<!doctype html>
<html lang=cmn-Hans>
<head>
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name=format-detection content="telephone=no">
  <link rel=stylesheet href="/bootstrap-lnn/dist/bootstrap-lnn.min.css">
  <link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" crossorigin=anonymous>
  <link rel=stylesheet href="/blog/css/common.css">
  <link rel=stylesheet href="/blog/css/rouge-syntax.css">
  
  <link rel=icon href="/site_icon.png">
  <link rel="shortcut icon" href="/site_icon.png">
  <link rel=apple-touch-icon href="/site_icon.png" sizes="160x160">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Javascript 版的原义字符串？ | LNN的博客！</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Javascript 版的原义字符串？" />
<meta name="author" content="DGCK81LNN" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="Javascript 版的原义字符串？ let s = cts`Hello, ``world``!`() // &quot;Hello, `world`!&quot; 几天前我发现在 Javascript 带标签的模板字符串(英文)语法中，标签完全可以由任何表达式充当，包括模板字符串本身。事情是这样的。" />
<meta property="og:description" content="Javascript 版的原义字符串？ let s = cts`Hello, ``world``!`() // &quot;Hello, `world`!&quot; 几天前我发现在 Javascript 带标签的模板字符串(英文)语法中，标签完全可以由任何表达式充当，包括模板字符串本身。事情是这样的。" />
<link rel="canonical" href="https://dgck81lnn.github.io/blog/posts/221008_js_verbatim_string" />
<meta property="og:url" content="https://dgck81lnn.github.io/blog/posts/221008_js_verbatim_string" />
<meta property="og:site_name" content="LNN的博客！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-08T10:03:44+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Javascript 版的原义字符串？" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DGCK81LNN","url":"https://github.com/DGCK81LNN"},"dateModified":"2023-04-26T19:28:00+08:00","datePublished":"2022-10-08T10:03:44+08:00","description":"Javascript 版的原义字符串？ let s = cts`Hello, ``world``!`() // &quot;Hello, `world`!&quot; 几天前我发现在 Javascript 带标签的模板字符串(英文)语法中，标签完全可以由任何表达式充当，包括模板字符串本身。事情是这样的。","headline":"Javascript 版的原义字符串？","mainEntityOfPage":{"@type":"WebPage","@id":"https://dgck81lnn.github.io/blog/posts/221008_js_verbatim_string"},"url":"https://dgck81lnn.github.io/blog/posts/221008_js_verbatim_string"}</script>
<!-- End Jekyll SEO tag -->

  
  <script defer crossorigin=anonymous
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"
  ></script>
  <script defer src="/blog/js/common.js"></script>
  
</head>

<body>
  <div class="visually-hidden-focusable position-absolute top-0 start-0 p-1 bg-light">
    <a href="#main">跳至正文</a>
  </div>

  <header class="d-flex justify-content-center py-3 mb-4 border-bottom shadow-sm bg-light">
    <span>LNN的博客！</span>
  </header>

  <div id="mainwrap">
    <nav id=nav>
      <ol class="breadcrumb bg-light rounded p-3">
        <li class="breadcrumb-item"><a href="/blog">LNN的博客！</a></li>
        <li class="breadcrumb-item active" aria-current="page">Javascript 版的原义字符串？</li>
      </ol>
    </nav>

    <main id=main>
<footer>
  <p class="text-muted">
    <a href="https://github.com/DGCK81LNN"
      >DGCK81LNN</a>
    &middot;
    <time datetime="2022-10-08T10:03:44+0800">2022-10-08 10:03</time>
    &middot;
    <span>最后更新于 <time datetime="2023-04-26T19:28:00+0800"
    >2023-04-26 19:28</time
    ></span>
      &middot;
      <span><span class=visually-hidden>标签：</span>
      <a href="/blog/tags/coding" class="text-decoration-none">
        <span class="badge bg-primary">编程</span>
      </a>
      <a href="/blog/tags/everyday-coding" class="text-decoration-none">
        <span class="badge bg-secondary">日常写代码</span>
      </a>
      </span>
  </p>
</footer>

<div class="soulblog-content">
<h1 id="javascript-版的原义字符串">Javascript 版的原义字符串？</h1>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">cts</span><span class="s2">`Hello, ``world``!`</span><span class="p">()</span> <span class="c1">// "Hello, `world`!"</span>
</code></pre></div></div>

<hr />

<p>几天前我发现在 Javascript <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Template_literals#带标签的模板字符串">带标签的模板字符串</a><sup><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#tagged_templates">(英文)</a></sup>语法中，标签完全可以由任何表达式充当，包括模板字符串本身。事情是这样的。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">`aaa``bbb`</span>
</code></pre></div></div>

<p>当我运行上面这个表达式时，得到的报错信息是</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TypeError: "aaa" is not a function
</code></pre></div></div>

<p>第一个模板字符串 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`aaa`</span></code> 被当作了第二个模板字符串 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`bbb`</span></code> 的标签，但因为它不是一个函数，所以得到了“不是函数”的错误。这意味着，即使这样</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">```js
console.log("等等……我们这是在 Markdown 里吗？")
```</span>
</code></pre></div></div>

<p>也是符合 Javascript 语法的，看起来就像是模板字符串里面可以包含双反引号，就像 C# 中的原义字符串一样……只是会报运行时错误罢了。</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="s">@"\反斜杠\不用转义，双引号转义成""两个双引号"""</span><span class="p">;</span>
<span class="kt">string</span> <span class="n">s2</span> <span class="p">=</span> <span class="s">@"""quoted"""</span><span class="p">;</span>
</code></pre></div></div>

<p>想到 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nb">String</span><span class="p">.</span><span class="nx">raw</span></code> 标签的字符串里面没有办法包含反引号（除非前面有奇数个反斜杠），我们或许可以让反引号可以转义成两个反引号。</p>

<p>要想让 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`aaa``bbb`</span></code> 返回 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="dl">"</span><span class="s2">aaa`bbb</span><span class="dl">"</span></code>，第一步是让它不要报错。这简单，只要在前面加个标签函数，让 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">tag</span><span class="s2">`aaa`</span></code> 返回一个标签函数就好了。</p>

<p>不过，因为字符串里面的反引号数量是不确定的，所以后面的 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`bbb`</span></code> 还得继续返回一个标签函数，万一后面还有个 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`ccc`</span></code> 呢。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">tag</span><span class="s2">`aaa``bbb``ccc``ddd`</span> <span class="c1">// "aaa`bbb`ccc`ddd"</span>
<span class="c1">// 拆开来看就是……</span>
<span class="kd">var</span> <span class="nx">tag2</span> <span class="o">=</span> <span class="nx">tag</span><span class="s2">`aaa`</span>
<span class="kd">var</span> <span class="nx">tag3</span> <span class="o">=</span> <span class="nx">tag2</span><span class="s2">`bbb`</span>
<span class="kd">var</span> <span class="nx">tag4</span> <span class="o">=</span> <span class="nx">tag3</span><span class="s2">`ccc`</span>
<span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">tag4</span><span class="s2">`ddd`</span>
</code></pre></div></div>

<p>这里 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">val</span></code> 仍然得是一个标签函数 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">tag5</span></code>，因为 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">tag4</span></code> 被调用的时候完全不会知道 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`ddd`</span></code> 之后还会不会有 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`eee`</span></code>。因为这是一个可以无限延续的“模板字符<em>串</em>串”，我们暂且给最前面的标签起名叫“<span lang="en">Continuable Template Strings</span>”——<code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">cts</span></code>。</p>

<p>由于整个<em>串</em>串最后的返回值是个函数，我们需要一种方法来取得我们要的字符串。可以给它添加一个 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">value</span></code> 成员，重写 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nf">valueOf</span><span class="p">()</span></code> 和/或 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nf">toString</span><span class="p">()</span></code> 方法……或者干脆让这个函数在没有参数传入时直接返回字符串。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">cts</span><span class="s2">`aaa``bbb`</span><span class="p">.</span><span class="nx">value</span>
<span class="nx">cts</span><span class="s2">`aaa``bbb`</span><span class="p">.</span><span class="nf">valueOf</span><span class="p">()</span>
<span class="nx">cts</span><span class="s2">`aaa``bbb`</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
<span class="nx">cts</span><span class="s2">`aaa``bbb`</span> <span class="o">+</span> <span class="dl">""</span> <span class="c1">// 隐式调用 .valueOf() 转换成字符串</span>
<span class="nx">cts</span><span class="s2">`aaa``bbb`</span> <span class="o">+</span> <span class="p">[]</span> <span class="c1">// 同上...?</span>
<span class="nx">cts</span><span class="s2">`aaa``bbb`</span><span class="p">()</span> <span class="c1">// 还是这个最简短！</span>
</code></pre></div></div>

<p>到这里思路就完整了，可以开始写代码了。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">cts</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nf">raw</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="c1">// 就假装咱们是直接拿 String.raw 当标签</span>
  <span class="kd">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">str</span>

    <span class="nx">str</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">`</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nf">raw</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">tag</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">tag</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里还有个更精致些的版本。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">cts</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">tag</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">value</span>

    <span class="nx">tag</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">`</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nf">raw</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">tag</span>
  <span class="p">}</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nf">defineProperties</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">writable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">value</span><span class="p">:</span> <span class="nb">String</span><span class="p">.</span><span class="nf">raw</span><span class="p">(...</span><span class="nx">args</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="na">toString</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">value</span><span class="p">:</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">tag</span>
<span class="p">}</span>
</code></pre></div></div>

<p>（说来我还是写这个的时候才知道，在带名称的函数字面量里面可以通过名称来引用函数自身。相当于 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span></code>。以前一直不知道这里加名称有什么用。）</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">f</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">f</span> <span class="p">}</span>
<span class="nf">a</span><span class="p">()</span> <span class="c1">// a</span>

<span class="c1">// 当然，对函数声明无效</span>
<span class="kd">function</span> <span class="nf">g</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">g</span> <span class="p">}</span>
<span class="kd">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">g</span>
<span class="nx">g</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span>
<span class="nf">h</span><span class="p">()</span> <span class="c1">// "foo"</span>
</code></pre></div></div>

<p>话说回来，刚才我们实现了“加强版 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nb">String</span><span class="p">.</span><span class="nx">raw</span></code>”，虽然现在可以包含反引号了，但仍然没办法写出以单个反斜杠结尾的字符串，因为反引号仍然会被反斜杠“假装转义掉”，字符串不会至此就结束。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">cts</span><span class="s2">`aaa</span><span class="se">\`</span><span class="s2">`</span><span class="p">()</span> <span class="c1">// "aaa\\`"</span>
</code></pre></div></div>

<p>看来 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nb">String</span><span class="p">.</span><span class="nx">raw</span></code> 的古怪特性被原封不动地遗传了下来：由于斜杠也会被斜杠“假装转义掉”，只有紧跟在<em>奇数个</em>斜杠后面的反引号不需要双写……</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">cts</span><span class="s2">`
1 个斜杠 </span><span class="se">\`</span><span class="s2">
2 个斜杠 </span><span class="se">\\</span><span class="s2">``
3 个斜杠 </span><span class="se">\\\`</span><span class="s2">
4 个斜杠 </span><span class="se">\\\\</span><span class="s2">``
5 个斜杠 </span><span class="se">\\\\\`</span><span class="s2">
`</span><span class="p">()</span>
</code></pre></div></div>

<p>（看起来目前版本的 Rouge 语法高亮不认识模板字符串里的“<code class="language-plaintext highlighter-rouge">\\</code>”，我得去发个 issue〔或者 PR〕。）</p>

<aside class="card my-3 w-75 mx-auto">
<div class="card-header">2022-12-10 更新</div>
<div class="card-body pb-0">
    <p><a href="https://github.com/rouge-ruby/rouge/pull/1878">我提交的 PR</a> 已经被合并了。</p>
  </div>
</aside>

<p>插值还是可以用的，并且也会被奇数个斜杠“假装转义掉”：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">cts</span><span class="s2">`</span><span class="p">${</span><span class="mi">111</span><span class="p">}</span><span class="s2">`</span><span class="p">()</span> <span class="c1">// "111"</span>
<span class="nx">cts</span><span class="s2">`</span><span class="se">\$</span><span class="s2">{111}`</span><span class="p">()</span> <span class="c1">// "\\${111}"</span>
<span class="nx">cts</span><span class="s2">`</span><span class="se">\\</span><span class="p">${</span><span class="mi">111</span><span class="p">}</span><span class="s2">`</span><span class="p">()</span> <span class="c1">// "\\\\111"</span>
</code></pre></div></div>

<p>如果前面不是奇数个斜杠的话，只能用插值来“转义”了。“<code class="language-plaintext highlighter-rouge">${</code>”或许需要转义成……<code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`</span><span class="p">${</span><span class="dl">"</span><span class="s2">${</span><span class="dl">"</span><span class="p">}</span><span class="s2">`</span></code>？<code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`</span><span class="p">${</span><span class="dl">"</span><span class="s2">$</span><span class="dl">"</span><span class="p">}</span><span class="s2">{`</span></code>？<code class="language-javascript highlight language-javascript highlighter-rouge"><span class="s2">`$</span><span class="p">${</span><span class="dl">""</span><span class="p">}</span><span class="s2">{`</span></code>？（这真的还算是转义吗？）</p>

<p>这些怪癖都是原义字符串和转义字符串的语法重合导致的，但凡像 C# 那样在语法上作一点区分（原义字符串前加“<code class="language-plaintext highlighter-rouge">@</code>”）也不至于变成现在的样子。</p>

<p>看来这个东西用处不大，咱们还是不拿它当原义字符串用了吧。看看有没有其他用法。</p>

<p>我记得在 C 语言里，两个字符串字面量之间只有空白的话，是会被合并作一个字符串处理的。不像 Javascript 这样需要用加号处理。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dna</span> <span class="o">=</span>
    <span class="s">"#include &lt;stdio.h&gt;</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"const char* dna =</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"    禁止套娃！;</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"int main() {</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"    // TODO: code a quine</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"}"</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO: code a quine</span>
<span class="p">}</span>
</code></pre></div></div>

<p>用刚才的思路，要想在 Javascript 里实现这种效果也很简单，只要把 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="dl">"</span><span class="s2">`</span><span class="dl">"</span> <span class="o">+</span></code> 去掉就行了。</p>

<p>不过，我刚才这段 C 代码的字符串里还有 <code class="language-plaintext highlighter-rouge">\n</code>。我们刚刚获取的可是原义字符串。要想获得“非原义”字符串，完全可以自己把传给标签函数的参数拼起来，比如我写的这个很难看懂的版本：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">identity</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="p">...</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="kc">undefined</span><span class="p">))</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">SyntaxError</span><span class="p">(</span><span class="dl">"</span><span class="s2">Syntax error in template literal</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nf">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">prev</span> <span class="o">+</span> <span class="nx">curr</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></div></div>

<p>不过 MDN 上的做法，是直接把“非原义”字符串放在本来是原义字符串的位置上丢给 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nb">String</span><span class="p">.</span><span class="nx">raw</span></code> 来处理。简单粗暴。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">identity</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="p">...</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nf">raw</span><span class="p">({</span> <span class="na">raw</span><span class="p">:</span> <span class="nx">parts</span> <span class="p">},</span> <span class="p">...</span><span class="nx">values</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>或许我们还可以让 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nf">cts</span><span class="p">()</span></code> 在第一个参数不是数组的时候把参数视为每两段模板字符串中间要插入的字符（<code class="language-plaintext highlighter-rouge">`</code> 或空字符串）和用来处理模板字符串的标签函数（<code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nb">String</span><span class="p">.</span><span class="nx">raw</span></code> 或 <code class="language-javascript highlight language-javascript highlighter-rouge"><span class="nx">identity</span></code>），返回一个新的标签函数。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">cts</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">joiner</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">`</span><span class="dl">"</span>
  <span class="kd">let</span> <span class="nx">underlyingTag</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">raw</span>
  <span class="kd">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="p">...</span><span class="nx">interp</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">raw</span>
      <span class="nx">parts</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">parts</span><span class="p">]</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">raw</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">interp</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">interp</span><span class="p">]</span>
    <span class="kd">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">newParts</span><span class="p">,</span> <span class="p">...</span><span class="nx">newInterp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">newParts</span><span class="p">)</span> <span class="k">return</span> <span class="nf">underlyingTag</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="p">...</span><span class="nx">interp</span><span class="p">)</span>

      <span class="nx">parts</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">joiner</span> <span class="o">+</span> <span class="nx">newParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">newParts</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">raw</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">raw</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">joiner</span> <span class="o">+</span> <span class="nx">newParts</span><span class="p">.</span><span class="nx">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">raw</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">newParts</span><span class="p">.</span><span class="nx">raw</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
      <span class="nx">interp</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">newInterp</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">tag</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">tag</span>
  <span class="p">}</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="k">return</span> <span class="nf">tag</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
  <span class="nx">joiner</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">??</span> <span class="nx">joiner</span>
  <span class="nx">underlyingTag</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">??</span> <span class="nx">underlyingTag</span>
  <span class="k">return</span> <span class="nx">tag</span>
<span class="p">}</span>

<span class="nx">cts</span><span class="s2">`Hello, ``world``!`</span><span class="p">()</span>     <span class="c1">// "Hello, `world`!"</span>
<span class="nf">cts</span><span class="p">()</span><span class="s2">`Hello, ``world``!`</span><span class="p">()</span>   <span class="c1">// "Hello, `world`!"（同上）</span>
<span class="nf">cts</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span><span class="s2">`Hello, ``world``!`</span><span class="p">()</span> <span class="c1">// "Hello, world!"</span>
<span class="nf">cts</span><span class="p">(</span><span class="dl">"</span><span class="s2">111</span><span class="dl">"</span><span class="p">,</span> <span class="nx">identity</span><span class="p">)</span><span class="s2">`Hello, </span><span class="se">\\</span><span class="s2">``world</span><span class="se">\\</span><span class="s2">``!`</span><span class="p">()</span> <span class="c1">// "Hello, \\111world\\111!"</span>

<span class="nf">cts</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span><span class="s2">`ABCDEFGHIJKLMNOPQRSTUVWXYZ`</span>
       <span class="s2">`abcdefghijklmnopqrstuvwxyz`</span>
       <span class="s2">`0123456789+/=`</span><span class="p">()</span>

<span class="nf">cts</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span>
<span class="s2">`pipi suno li kama jo e ilo suno.`</span>
<span class="s2">`tenpo pimeja la, ona li tawa sama waso.`</span>
<span class="s2">`ona li wile mute lukin e jan olin,`</span>
<span class="s2">`li alasa e olin.`</span><span class="p">()</span> <span class="c1">// 甚至把 \n 都省去了。</span>
</code></pre></div></div>

<p>最后两个例子看起来似乎还不错，可以写出漂亮的多行字符串，并且可以随便缩进。不过 <a href="https://prettier.io/playground/#N4Igxg9gdgLgprEAucMDOAKAOiLWo4CU+ABgA4CWlABGgK5QTUA2F1A1gIYC2n1AVkzjUKzJvUYA6EqXhQyTStzj8+zTgBpq0NWxicA7nzQ8+RtBGmkdLNgdHDudeCzrsKUasNWeIrKBoyUCSs1JzqJl7a-tIYhCAaIBBkMBTQaMignABO2RAGAAo5CBko4UYAnhmJAEbZnGDscDAAyjxwADIecMgAZuFocLX1jc0tZA0eAObIMNl0QyBw3DVwACZr6x2cUFN0nFNwAGIQ2bwwqbvIIJzOEAkgABYw3MwA6o8U8GgTYHAtJS+FAAbl8KtcwGhqiAPINsjACvUprw+gNFvw0AAPFrTZhwACKdAg8FRzEGiQm2Th1xqnFWzAeZGyHhgbwoaxgj2QAA4AAwUvKDN71MjXJlwOHAnqJACORPgiOSpRuaAAtFA4Ot1g9snA5RRdYiDiikP0yYtBtwKKTySA0LiCfKeqa0Yl9DU2RyuUgAExu+qiaYAYQg3BNSzQAFYHnRBgAVOmlM224ELACSUE2sBaYGZKQAgpmWjAKnibXAAL4VoA" title="Prettier playground">Prettier 似乎不太喜欢我的这种写法</a>。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">cts</span><span class="p">(</span>
  <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span>
<span class="p">)</span><span class="s2">`pipi suno li kama jo e ilo suno.``tenpo pimeja la, ona li tawa sama waso.``ona li wile mute lukin e jan olin,``li alasa e olin.`</span><span class="p">()</span>
<span class="c1">// :(</span>
</code></pre></div></div>

<p>没用，散了吧。</p>

<p>我的评价是，不如老老实实用反斜杠转义。</p>


</div>

<hr>

<section>
  <h2>评论区</h2>
  <script defer src="https://utteranc.es/client.js" crossorigin=anonymous
    data-theme=github-light
    data-repo="DGCK81LNN/blog" data-label="utterances comments"
    data-issue-term="/posts/221008_js_verbatim_string"
  ></script>
  <div class="soulblog-utterances-placeholder d-flex flex-column justify-content-center align-items-center">
    <div class="spinner-border text-primary" role=status></div>
    <p class="text-muted mt-3">
      加载基于 GitHub issues 的 <a href="https://utteranc.es/" crossorigin=anonymous>utteranc.es</a> 评论区组件……
    </p>
  </div>
</section>

    </main>
  </div>

  <footer class="mt-4 px-2 py-4 bg-light border-top">
    <div id=footer class="mx-auto">
      <div class="mb-2 d-flex gap-2 justify-content-between align-items-center flex-wrap">
        <div>
          <a class="d-block"
            href="https://github.com/DGCK81LNN/blog/blob/main/_posts/2022-10-08-js_verbatim_string.md?plain=1">
            <img class="d-block" alt="在GitHub上查看源代码"
              src="https://img.shields.io/badge/-在GitHub上查看源代码-222222?logo=github" />
          </a>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <a class="d-block" href="https://notbyai.fyi" lang="en">
            <img class="d-block" alt="written by human, not by AI"
              src="/blog/assets/Written-By-Human-Not-By-AI-Badge-white.svg"/>
          </a>
          <a class="d-block" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh-hans">
            <img class="d-block" alt="CC BY-SA"
              src="/blog/assets/by-sa.svg"/>
          </a>
        </div>
      </div>
      <div class="text-secondary mb-2">
        <p>本站图文内容除另有声明外，均在<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh-hans"
          >知识共享 署名-相同方式共享 4.0 国际（CC BY-SA 4.0）许可协议</a
          >下发布。</p>
      </div>
      <div class="d-flex flex-wrap mb-0">
        <a href="/">灵魂小站首页</a>
        <span class="mx-2 vr"></span>
        <a rel=nofollow href="https://github.com/DGCK81LNN/">我的 GitHub</a>
        <span class="mx-2 vr"></span>
        <span>QQ: 3470524928</span>
      </div>
    </div>
  </footer>
</body>
</html>
<!------------------------------------------------------------------------------
  page:
    path: "_posts/2022-10-08-js_verbatim_string.md"
    dir: null
    name: "2022-10-08-js_verbatim_string.md"
    url: "/posts/221008_js_verbatim_string"
    collection: "posts"
    layout: "posts"
------------------------------------------------------------------------------->
