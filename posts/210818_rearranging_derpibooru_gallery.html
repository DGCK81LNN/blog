<!doctype html>
<html lang=cmn-Hans>
<head>
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name=format-detection content="telephone=no">
  <link rel=stylesheet href="/bootstrap-lnn/dist/bootstrap-lnn.min.css">
  <link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" crossorigin=anonymous>
  <link rel=stylesheet href="/blog/css/common.css">
  <link rel=stylesheet href="/blog/css/rouge-syntax.css">
  
  <link rel=icon href="/site_icon.png">
  <link rel="shortcut icon" href="/site_icon.png">
  <link rel=apple-touch-icon href="/site_icon.png" sizes="160x160">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>用自动脚本整理 Derpibooru 图集 | LNN的博客！</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="用自动脚本整理 Derpibooru 图集" />
<meta name="author" content="DGCK81LNN" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="用自动脚本整理 Derpibooru 图集 我在 Derpibooru 做了一个图集“M6就要整整齐齐”，里面的图片都是每6张为一组。我今天写了一个自动脚本来给这个图集的图片整理排序。 Derpibooru 官方没有提供修改图集内图片顺序的 API；我通过浏览器开发者工具找到了这个 API。它的工作原理很迷，我没有看懂……废话，我不会 Elixir。这是它的源代码。" />
<meta property="og:description" content="用自动脚本整理 Derpibooru 图集 我在 Derpibooru 做了一个图集“M6就要整整齐齐”，里面的图片都是每6张为一组。我今天写了一个自动脚本来给这个图集的图片整理排序。 Derpibooru 官方没有提供修改图集内图片顺序的 API；我通过浏览器开发者工具找到了这个 API。它的工作原理很迷，我没有看懂……废话，我不会 Elixir。这是它的源代码。" />
<link rel="canonical" href="https://dgck81lnn.github.io/blog/posts/210818_rearranging_derpibooru_gallery" />
<meta property="og:url" content="https://dgck81lnn.github.io/blog/posts/210818_rearranging_derpibooru_gallery" />
<meta property="og:site_name" content="LNN的博客！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-18T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="用自动脚本整理 Derpibooru 图集" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DGCK81LNN","url":"https://github.com/DGCK81LNN"},"dateModified":"2022-04-15T11:35:00+08:00","datePublished":"2021-08-18T00:00:00+08:00","description":"用自动脚本整理 Derpibooru 图集 我在 Derpibooru 做了一个图集“M6就要整整齐齐”，里面的图片都是每6张为一组。我今天写了一个自动脚本来给这个图集的图片整理排序。 Derpibooru 官方没有提供修改图集内图片顺序的 API；我通过浏览器开发者工具找到了这个 API。它的工作原理很迷，我没有看懂……废话，我不会 Elixir。这是它的源代码。","headline":"用自动脚本整理 Derpibooru 图集","mainEntityOfPage":{"@type":"WebPage","@id":"https://dgck81lnn.github.io/blog/posts/210818_rearranging_derpibooru_gallery"},"url":"https://dgck81lnn.github.io/blog/posts/210818_rearranging_derpibooru_gallery"}</script>
<!-- End Jekyll SEO tag -->

  
  <script defer crossorigin=anonymous
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"
  ></script>
  <script defer src="/blog/js/common.js"></script>
  
</head>

<body>
  <div class="visually-hidden-focusable position-absolute top-0 start-0 p-1 bg-light">
    <a href="#main">跳至正文</a>
  </div>

  <header class="d-flex justify-content-center py-3 mb-4 border-bottom shadow-sm bg-light">
    <span>LNN的博客！</span>
  </header>

  <div id="mainwrap">
    <nav id=nav>
      <ol class="breadcrumb bg-light rounded p-3">
        <li class="breadcrumb-item"><a href="/blog">LNN的博客！</a></li>
        <li class="breadcrumb-item active" aria-current="page">用自动脚本整理 Derpibooru 图集</li>
      </ol>
    </nav>

    <main id=main>
<footer>
  <p class="text-muted">
    <a href="https://github.com/DGCK81LNN"
      >DGCK81LNN</a>
    &middot;
    <time datetime="2021-08-18T00:00:00+0800">2021-08-18</time>
    &middot;
    <span>最后更新于 <time datetime="2022-04-15T11:35:00+0800"
    >2022-04-15 11:35</time
    ></span>
      &middot;
      <span><span class=visually-hidden>标签：</span>
      <a href="/blog/tags/coding" class="text-decoration-none">
        <span class="badge bg-primary">编程</span>
      </a>
      <a href="/blog/tags/everyday-coding" class="text-decoration-none">
        <span class="badge bg-secondary">日常写代码</span>
      </a>
      </span>
  </p>
</footer>

<div class="soulblog-content">
<h1 id="用自动脚本整理-derpibooru-图集">用自动脚本整理 <a href="https://derpibooru.org">Derpibooru</a> 图集</h1>

<p>我在 Derpibooru 做了一个图集“<a href="https://derpibooru.org/galleries/14196">M6就要整整齐齐</a>”，里面的图片都是每6张为一组。我今天写了一个自动脚本来给这个图集的图片整理排序。</p>

<p>Derpibooru 官方没有提供修改图集内图片顺序的 <abbr title="应用程序编程接口">API</abbr>；我通过浏览器开发者工具找到了这个 <abbr title="应用程序编程接口">API</abbr>。它的工作原理很迷，我没有看懂……<del>废话，我不会 <a href="https://elixir-lang.org/">Elixir</a>。</del><a href="https://github.com/derpibooru/philomena/blob/355ce491accae4702f273334271813e93a261e0f/lib/philomena/galleries.ex#L277:L339">这是它的源代码</a>。</p>

<p>以下代码需要在 Derpibooru 页面上用开发组工具的控制台运行，因为它使用了相对路径的 <abbr title="应用程序编程接口">API</abbr> 网址和全局对象 <code class="language-plaintext highlighter-rouge">booru</code>。在其他基于 <span lang="en"><a href="https://github.com/derpibooru/philomena">Philomena</a></span> 的图站上应该也可以运行，但要记得修改 <code class="language-plaintext highlighter-rouge">filterId</code>。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">galleryId</span> <span class="o">=</span> <span class="mi">14196</span><span class="p">;</span> <span class="c1">// 图集ID</span>
  <span class="kd">const</span> <span class="nx">perSet</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">// 每个图组的图片数量</span>
  <span class="kd">const</span> <span class="nx">perPage</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// 获取图集内所有图片时，每页返回多少张（最高50）</span>
  <span class="kd">const</span> <span class="nx">filterId</span> <span class="o">=</span> <span class="mi">56027</span><span class="p">;</span> <span class="c1">// 图片过滤器编号（这里使用的是 Everything）</span>

  <span class="kd">const</span> <span class="nx">listImagesApi</span> <span class="o">=</span> <span class="s2">`/api/v1/json/search/images?q=gallery_id:</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">&amp;sf=gallery_id:</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">&amp;sd=asc&amp;filter_id=</span><span class="p">${</span><span class="nx">filterId</span><span class="p">}</span><span class="s2">&amp;per_page=</span><span class="p">${</span><span class="nx">perPage</span><span class="p">}</span><span class="s2">&amp;page=`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">orderImagesApi</span> <span class="o">=</span> <span class="s2">`/galleries/</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">/order`</span><span class="p">;</span>

  <span class="c1">// main procedure</span>
  <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getImgList</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">original data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">current</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sorted</span> <span class="o">=</span> <span class="nf">sortImgs</span><span class="p">(</span><span class="nx">current</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">sorted data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">);</span>
  <span class="k">await</span> <span class="nf">submitOrder</span><span class="p">([...</span><span class="nx">sorted</span><span class="p">].</span><span class="nf">reverse</span><span class="p">());</span>

  <span class="cm">/**
   * 获取图集内图片
   * @returns {number[]} 图片ID列表
   */</span>
  <span class="k">async</span> <span class="kd">function</span> <span class="nf">getImgList</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET IMAGE LIST...</span><span class="dl">"</span><span class="p">);</span>
    <span class="cm">/** @type {number[]} */</span> <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="k">await </span><span class="p">(</span><span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">listImagesApi</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)).</span><span class="nf">text</span><span class="p">());</span>
      <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">images</span><span class="dl">"</span><span class="p">].</span><span class="nf">map</span><span class="p">((</span><span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">i</span><span class="p">[</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">]));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`✓ page </span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2"> of </span><span class="p">${</span><span class="nb">Math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">]</span> <span class="o">/</span> <span class="nx">perPage</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while </span><span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">*</span> <span class="nx">perPage</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">]);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`FETCH COMPLETE!`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**
   * 排序图片：每个图组内图片按ID排序，图组按首张图片ID排序
   * @param {number[]} current 当前图片ID列表
   * @returns {number[]} 排序后的图片ID列表
   */</span>
  <span class="kd">function</span> <span class="nf">sortImgs</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/** @type {number[][]} */</span> <span class="kd">var</span> <span class="nx">sets</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">current</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">perSet</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="kd">set</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">perSet</span><span class="p">);</span>
      <span class="kd">set</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">);</span>
      <span class="nx">sets</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="kd">set</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">sets</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">sets</span><span class="p">.</span><span class="nf">flat</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="cm">/**
   * 提交新的图片顺序到服务器
   * @param {number[]} sorted
   */</span>
  <span class="kd">function</span> <span class="nf">submitOrder</span><span class="p">(</span><span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">SUBMITTING DATA...</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">PATCH</span><span class="dl">"</span><span class="p">,</span> <span class="nx">orderImagesApi</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">x-csrf-token</span><span class="dl">"</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">booru</span><span class="p">.</span><span class="nx">csrfToken</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
      <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span>
        <span class="na">image_ids</span><span class="p">:</span> <span class="p">[...</span><span class="nx">sorted</span><span class="p">],</span>
        <span class="na">_method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PATCH</span><span class="dl">"</span>
      <span class="p">})</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DONE!</span><span class="dl">"</span><span class="p">);</span>
        <span class="nf">resolve</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nf">reject</span><span class="p">(</span><span class="dl">"</span><span class="s2">REQUEST FAILED!</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">})().</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
</code></pre></div></div>

<h2 id="2022-02-16-edit">2022-02-16 EDIT</h2>

<p>我现在使用的最新代码。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @typedef {{
 *   comment_count: number,
 *   created_at: string,
 *   downvotes: number,
 *   faves: number,
 *   first_seen_at: string,
 *   id: number,
 *   score: number,
 *   size: number,
 *   tag_count: number,
 *   updated_at: string,
 *   upvotes: number,
 *   wilson_score: number,
 * }} ImageResponse
 */</span>

<span class="kd">const</span> <span class="nx">perPage</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1">// 获取图集内所有图片时，每页返回多少张（最高50）</span>
<span class="kd">const</span> <span class="nx">filterId</span> <span class="o">=</span> <span class="mi">56027</span> <span class="c1">// 图片过滤器编号（Everything）</span>

<span class="cm">/**
 * 获取图集内图片
 * @param {number} galleryId 图集ID
 * @param {number} perSet 每个图组的图片数量
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">getImgList</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">,</span> <span class="nx">perSet</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">listImagesApi</span> <span class="o">=</span> <span class="s2">`/api/v1/json/search/images?q=gallery_id:</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">&amp;sf=gallery_id:</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">&amp;sd=asc&amp;filter_id=</span><span class="p">${</span><span class="nx">filterId</span><span class="p">}</span><span class="s2">&amp;per_page=</span><span class="p">${</span><span class="nx">perPage</span><span class="p">}</span><span class="s2">&amp;page=`</span>

  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET IMAGE LIST...</span><span class="dl">"</span><span class="p">)</span>
  <span class="cm">/** @type {ImageResponse[]} */</span> <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="k">do</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="k">await </span><span class="p">(</span><span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">listImagesApi</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)).</span><span class="nf">text</span><span class="p">())</span>
    <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">images</span><span class="dl">"</span><span class="p">])</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`✓ page </span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2"> of </span><span class="p">${</span><span class="nb">Math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">]</span> <span class="o">/</span> <span class="nx">perPage</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">while </span><span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">*</span> <span class="nx">perPage</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">])</span>

  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`FETCH COMPLETE!`</span><span class="p">)</span>

  <span class="cm">/** @type {ImageResponse[][]} */</span> <span class="kd">var</span> <span class="nx">sets</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">perSet</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="kd">set</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">perSet</span><span class="p">)</span>
    <span class="nx">sets</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="kd">set</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">sets</span>
<span class="p">}</span>

<span class="cm">/**
 * @param {ImageResponse[][]} sets
 */</span>
<span class="kd">function</span> <span class="nf">toIds</span><span class="p">(</span><span class="nx">sets</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sets</span><span class="p">.</span><span class="nf">flat</span><span class="p">().</span><span class="nf">map</span><span class="p">(</span><span class="nx">img</span> <span class="o">=&gt;</span> <span class="nx">img</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>

<span class="cm">/**
 * 提交新的图片顺序到服务器
 * @param {number} galleryId 图集ID
 * @param {number[]} sorted
 */</span>
<span class="kd">function</span> <span class="nf">submitOrder</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">orderImagesApi</span> <span class="o">=</span> <span class="s2">`/galleries/</span><span class="p">${</span><span class="nx">galleryId</span><span class="p">}</span><span class="s2">/order`</span>

  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">SUBMITTING DATA...</span><span class="dl">"</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">()</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">PATCH</span><span class="dl">"</span><span class="p">,</span> <span class="nx">orderImagesApi</span><span class="p">)</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">x-csrf-token</span><span class="dl">"</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">booru</span><span class="p">.</span><span class="nx">csrfToken</span><span class="p">)</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span>
      <span class="na">image_ids</span><span class="p">:</span> <span class="p">[...</span><span class="nx">sorted</span><span class="p">],</span>
      <span class="na">_method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PATCH</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">})</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DONE!</span><span class="dl">"</span><span class="p">)</span>
      <span class="nf">resolve</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nf">reject</span><span class="p">(</span><span class="dl">"</span><span class="s2">REQUEST FAILED!</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 整理主图集</span>

<span class="kd">var</span> <span class="nx">galleryId</span> <span class="o">=</span> <span class="mi">14196</span>
<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getImgList</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">original data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">coverIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="nx">current</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="kd">set</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">set</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">id</span> <span class="o">-</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="kd">set</span><span class="p">.</span><span class="nx">_wilsonSum</span> <span class="o">=</span> <span class="kd">set</span><span class="p">.</span><span class="nf">reduce</span><span class="p">((</span><span class="nx">s</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">s</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wilson_score</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">if </span><span class="p">(</span><span class="kd">set</span><span class="p">.</span><span class="nf">findIndex</span><span class="p">(</span><span class="nx">img</span> <span class="o">=&gt;</span> <span class="nx">img</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">2461114</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">coverIndex</span> <span class="o">=</span> <span class="nx">i</span>
<span class="p">})</span>
<span class="k">if </span><span class="p">(</span><span class="nx">coverIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">throw</span> <span class="dl">"</span><span class="s2">cover set not found</span><span class="dl">"</span>
<span class="kd">var</span> <span class="nx">coverSet</span> <span class="o">=</span> <span class="nx">current</span><span class="p">[</span><span class="nx">coverIndex</span><span class="p">]</span>

<span class="kd">var</span> <span class="nx">wilsonSorted</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nf">slice</span><span class="p">()</span>
<span class="nx">wilsonSorted</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="nx">coverIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">wilsonSorted</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_wilsonSum</span> <span class="o">-</span> <span class="nx">l</span><span class="p">.</span><span class="nx">_wilsonSum</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nf">toIds</span><span class="p">([</span>
  <span class="p">...</span><span class="nx">wilsonSorted</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">sort</span><span class="p">((</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">l</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">id</span> <span class="o">-</span> <span class="nx">r</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">id</span><span class="p">),</span>
  <span class="p">...</span><span class="nx">wilsonSorted</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="nf">reverse</span><span class="p">(),</span>
  <span class="nx">coverSet</span><span class="p">,</span>
<span class="p">])</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">sorted data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

<span class="k">await</span> <span class="nf">submitOrder</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nf">slice</span><span class="p">().</span><span class="nf">reverse</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 整理其他图集</span>

<span class="kd">var</span> <span class="nx">galleryId</span> <span class="o">=</span> <span class="mi">18473</span>
<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getImgList</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">original data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span>

<span class="nx">current</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="kd">set</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">set</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">id</span> <span class="o">-</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nf">toIds</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">l</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">id</span> <span class="o">-</span> <span class="nx">r</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">id</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">sorted data: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

<span class="k">await</span> <span class="nf">submitOrder</span><span class="p">(</span><span class="nx">galleryId</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nf">slice</span><span class="p">().</span><span class="nf">reverse</span><span class="p">())</span>
</code></pre></div></div>

</div>

<hr>

<section>
  <h2>评论区</h2>
  <script defer src="https://utteranc.es/client.js" crossorigin=anonymous
    data-theme=github-light
    data-repo="DGCK81LNN/blog" data-label="utterances comments"
    data-issue-term="/posts/210818_rearranging_derpibooru_gallery"
  ></script>
  <div class="soulblog-utterances-placeholder d-flex flex-column justify-content-center align-items-center">
    <div class="spinner-border text-primary" role=status></div>
    <p class="text-muted mt-3">
      加载基于 GitHub issues 的 <a href="https://utteranc.es/" crossorigin=anonymous>utteranc.es</a> 评论区组件……
    </p>
  </div>
</section>

    </main>
  </div>

  <footer class="mt-4 px-2 py-4 bg-light border-top">
    <div id=footer class="mx-auto">
      <div class="mb-2 d-flex gap-2 justify-content-between align-items-center flex-wrap">
        <div>
          <a class="d-block"
            href="https://github.com/DGCK81LNN/blog/blob/main/_posts/2021-08-18-rearranging_derpibooru_gallery.md?plain=1">
            <img class="d-block" alt="在GitHub上查看源代码"
              src="https://img.shields.io/badge/-在GitHub上查看源代码-222222?logo=github" />
          </a>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <a class="d-block" href="https://notbyai.fyi" lang="en">
            <img class="d-block" alt="written by human, not by AI"
              src="/blog/assets/Written-By-Human-Not-By-AI-Badge-white.svg"/>
          </a>
          <a class="d-block" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh-hans">
            <img class="d-block" alt="CC BY-SA"
              src="/blog/assets/by-sa.svg"/>
          </a>
        </div>
      </div>
      <div class="text-secondary mb-2">
        <p>本站图文内容除另有声明外，均在<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh-hans"
          >知识共享 署名-相同方式共享 4.0 国际（CC BY-SA 4.0）许可协议</a
          >下发布。</p>
      </div>
      <div class="d-flex flex-wrap mb-0">
        <a href="/">灵魂小站首页</a>
        <span class="mx-2 vr"></span>
        <a rel=nofollow href="https://github.com/DGCK81LNN/">我的 GitHub</a>
        <span class="mx-2 vr"></span>
        <span>QQ: 3470524928</span>
      </div>
    </div>
  </footer>
</body>
</html>
<!------------------------------------------------------------------------------
  page:
    path: "_posts/2021-08-18-rearranging_derpibooru_gallery.md"
    dir: null
    name: "2021-08-18-rearranging_derpibooru_gallery.md"
    url: "/posts/210818_rearranging_derpibooru_gallery"
    collection: "posts"
    layout: "posts"
------------------------------------------------------------------------------->
